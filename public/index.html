<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Â•ΩÁ¶ÆÂç≥ÊôÇÊäΩ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background: #f0f8ff;
        color: #333;
        text-align: center;
    }
    h1 {
        color: #2c3e50;
        margin-bottom: 40px;
    }
    .section {
        background: white;
        padding: 40px 20px;
        border-radius: 15px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    #drawBtn {
        width: 100%;
        padding: 30px;
        font-size: 32px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        margin: 20px 0;
        transition: background 0.3s;
    }
    #drawBtn:hover:not(:disabled) {
        background: #c0392b;
    }
    #drawBtn:disabled {
        background: #95a5a6;
        cursor: not-allowed;
    }
    #result {
        font-size: 36px;
        min-height: 100px;
        font-weight: bold;
        color: #27ae60;
        margin: 40px 0;
    }
    /* ÊäΩÁçéÂãïÁï´ */
    .spinner {
        display: inline-block;
        width: 60px;
        height: 60px;
        border: 8px solid #f3f3f3;
        border-top: 8px solid #e74c3c;
        border-radius: 50%;
        animation: spin 1.5s linear infinite;
        margin: 20px auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    #status {
        color: #7f8c8d;
        font-style: italic;
        margin-top: 20px;
    }
</style>
</head>
<body>
    <h1>Â•ΩÁ¶ÆÂç≥ÊôÇÊäΩ</h1>

    <div class="section">
        <button id="drawBtn" onclick="startDraw()">ÈñãÂßãÊäΩÁçéÔºÅ</button>

        <!-- ÊäΩÁçéÈÅéÁ®ãËàáÁµêÊûúÈ°ØÁ§∫ÂçÄ -->
        <div id="animation"></div>
        <div id="result"></div>
        <div id="status">Á≥ªÁµ±ËºâÂÖ•‰∏≠...</div>
    </div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<!-- SheetJS for Excel reading -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    const firebaseConfig = {
      apiKey: "‰Ω†ÁöÑ apiKey",
      authDomain: "amc-lottery.firebaseapp.com",
      databaseURL: "https://amc-lottery-default-rtdb.firebaseio.com",
      projectId: "amc-lottery",
      storageBucket: "amc-lottery.appspot.com",
      messagingSenderId: "‰Ω†ÁöÑ messagingSenderId",
      appId: "‰Ω†ÁöÑ appId"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const prizesRef = db.ref('prizes');

    let prizes = [];
    const statusEl = document.getElementById('status');
    const drawBtn = document.getElementById('drawBtn');
    const animationEl = document.getElementById('animation');
    const resultEl = document.getElementById('result');

    // È†ÅÈù¢ËºâÂÖ•ÊôÇËá™ÂãïËÆÄÂèñ gifts.xlsx ‰∏¶ÂàùÂßãÂåñË≥áÊñôÂ∫´
    window.onload = function() {
        fetch('gifts.xlsx')
            .then(response => {
                if (!response.ok) throw new Error('Êâæ‰∏çÂà∞ gifts.xlsx');
                return response.arrayBuffer();
            })
            .then(data => {
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                const excelPrizes = json.slice(1)
                    .filter(row => row[0] && row[1] > 0)
                    .map(row => ({
                        name: row[0].toString().trim(),
                        total: parseInt(row[1]) || 0,
                        remain: parseInt(row[1]) || 0
                    }));

                if (excelPrizes.length === 0) {
                    statusEl.textContent = 'ÈåØË™§Ôºögifts.xlsx ‰∏≠Ê≤íÊúâÊúâÊïàÁçéÂìÅË≥áÊñô';
                    return;
                }

                prizesRef.once('value').then(snapshot => {
                    const currentData = snapshot.val();
                    let needUpdate = false;

                    if (!currentData || Object.keys(currentData).length !== excelPrizes.length) {
                        needUpdate = true;
                    } else {
                        const currentPrizes = Object.values(currentData);
                        for (let i = 0; i < excelPrizes.length; i++) {
                            if (currentPrizes[i].name !== excelPrizes[i].name ||
                                currentPrizes[i].total !== excelPrizes[i].total) {
                                needUpdate = true;
                                break;
                            }
                        }
                    }

                    if (needUpdate) {
                        statusEl.textContent = 'Ê≠£Âú®ÂàùÂßãÂåñÁçéÂìÅË≥áÊñô...';
                        const newPrizes = {};
                        excelPrizes.forEach(p => {
                            const key = prizesRef.push().key;
                            newPrizes[key] = { name: p.name, total: p.total, remain: p.remain };
                        });
                        prizesRef.set(newPrizes).then(() => {
                            statusEl.textContent = 'Á≥ªÁµ±Â∑≤Â∞±Á∑íÔºåÊ≠°ËøéÊäΩÁçéÔºÅ';
                        });
                    } else {
                        statusEl.textContent = 'Á≥ªÁµ±Â∑≤Â∞±Á∑íÔºåÊ≠°ËøéÊäΩÁçéÔºÅ';
                    }
                });
            })
            .catch(err => {
                statusEl.textContent = 'ÈåØË™§Ôºö' + err.message;
                console.error(err);
            });
    };

    // Âç≥ÊôÇÁõ£ËÅΩÁçéÂìÅÂâ©È§òÊï∏ÈáèÔºàÁî®‰æÜÂà§Êñ∑ÊòØÂê¶ÈÇÑÊúâÁçéÂèØÊäΩÔºâ
    prizesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            prizes = Object.keys(data).map(key => ({
                id: key,
                name: data[key].name,
                total: data[key].total,
                remain: data[key].remain
            }));
        } else {
            prizes = [];
        }
        updateDrawButton();
    });

    function updateDrawButton() {
        const canDraw = prizes.some(p => p.remain > 0);
        drawBtn.disabled = !canDraw;
        if (!canDraw && prizes.length > 0) {
            resultEl.textContent = 'Êú¨Ëº™ÁçéÂìÅÂ∑≤ÂÖ®ÈÉ®ÊäΩÂÆåÔºÅ';
            drawBtn.textContent = 'ÁçéÂìÅÂ∑≤ÊäΩÂÆå';
        }
    }

    // ÈñãÂßãÊäΩÁçéÔºöÈ°ØÁ§∫ÂãïÁï´ 3 ÁßíÂæåÈ°ØÁ§∫ÁµêÊûú
    function startDraw() {
        if (prizes.filter(p => p.remain > 0).length === 0) return;

        // È°ØÁ§∫ÊäΩÁçé‰∏≠ÁãÄÊÖã
        drawBtn.disabled = true;
        drawBtn.textContent = 'ÊäΩÁçé‰∏≠‚Ä¶';
        resultEl.textContent = '';
        animationEl.innerHTML = '<div class="spinner"></div>';

        // Ê®°Êì¨ÊäΩÁçéÊôÇÈñìÔºà3ÁßíÔºâ
        setTimeout(() => {
            performDraw();
        }, 3000);
    }

    // ÂØ¶ÈöõÂü∑Ë°åÊäΩÁçéÈÇèËºØ
    function performDraw() {
        const available = prizes.filter(p => p.remain > 0);
        const totalRemain = available.reduce((sum, p) => sum + p.remain, 0);
        let random = Math.random() * totalRemain;
        let selected;

        for (const item of available) {
            random -= item.remain;
            if (random <= 0) {
                selected = item;
                break;
            }
        }

        // Êõ¥Êñ∞Ë≥áÊñôÂ∫´
        db.ref('prizes/' + selected.id + '/remain').set(selected.remain - 1);

        // È°ØÁ§∫ÁµêÊûú
        animationEl.innerHTML = '';
        resultEl.textContent = `üéâ ÊÅ≠ÂñúÊäΩ‰∏≠Ôºö${selected.name} üéâ`;
        drawBtn.textContent = 'ÂÜçÊäΩ‰∏ÄÊ¨°ÔºÅ';
        drawBtn.disabled = false;
    }
</script>
</body>
</html>