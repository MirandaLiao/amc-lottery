<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Ëá™ÂãïÊäΩÁçéÁ≥ªÁµ±</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background: #f0f8ff; color: #333; }
    h1 { text-align: center; color: #2c3e50; }
    .section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #ecf0f1; }
    button { padding: 12px 24px; font-size: 18px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #c0392b; }
    button:disabled { background: #95a5a6; cursor: not-allowed; }
    #drawBtn { width: 100%; padding: 20px; font-size: 28px; margin-top: 20px; }
    #result { font-size: 36px; text-align: center; margin: 40px 0; min-height: 80px; color: #27ae60; font-weight: bold; }
    #status { text-align: center; color: #7f8c8d; font-style: italic; }
</style>
</head>
<body>
    <h1>Â•ΩÁ¶ÆÂç≥ÊôÇÊäΩ</h1>


    <div class="section" style="text-align:center;">
        <button id="drawBtn" onclick="draw()" disabled>ÈñãÂßãÊäΩÁçéÔºÅ</button>
        <div id="result"></div>
    </div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<!-- SheetJS for Excel reading -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    // ===== Ë´ãÁ¢∫Ë™çÈÄôË£°ÊòØ‰Ω†ÁöÑ firebaseConfig =====
    const firebaseConfig = {
      apiKey: "‰Ω†ÁöÑ apiKey",
      authDomain: "amc-lottery.firebaseapp.com",
      databaseURL: "https://amc-lottery-default-rtdb.firebaseio.com",
      projectId: "amc-lottery",
      storageBucket: "amc-lottery.appspot.com",
      messagingSenderId: "‰Ω†ÁöÑ messagingSenderId",
      appId: "‰Ω†ÁöÑ appId"
    };
    // ========================================

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const prizesRef = db.ref('prizes');

    let prizes = [];

    // ÁãÄÊÖãÈ°ØÁ§∫
    const statusEl = document.getElementById('status');

    // È†ÅÈù¢ËºâÂÖ•ÊôÇËá™ÂãïËÆÄÂèñ gifts.xlsx
    window.onload = function() {
        fetch('gifts.xlsx')
            .then(response => {
                if (!response.ok) throw new Error('Êâæ‰∏çÂà∞ gifts.xlsx');
                return response.arrayBuffer();
            })
            .then(data => {
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                // ÂæûÁ¨¨‰∫åÂàóÈñãÂßãËÆÄÂèñÔºàÂÅáË®≠Á¨¨‰∏ÄÂàóÊòØÊ®ôÈ°åÔºâ
                const excelPrizes = json.slice(1)
                    .filter(row => row[0] && row[1] > 0)
                    .map(row => ({
                        name: row[0].toString().trim(),
                        total: parseInt(row[1]) || 0,
                        remain: parseInt(row[1]) || 0
                    }));

                if (excelPrizes.length === 0) {
                    statusEl.textContent = 'ÈåØË™§Ôºögifts.xlsx ‰∏≠Ê≤íÊúâÊúâÊïàÁçéÂìÅË≥áÊñô';
                    return;
                }

                // Ê™¢Êü•Ë≥áÊñôÂ∫´ÊòØÂê¶Â∑≤ÊúâÁõ∏ÂêåÁçéÂìÅÔºàÁî®ÂêçÁ®±+Êï∏ÈáèÊØîÂ∞çÔºâ
                prizesRef.once('value').then(snapshot => {
                    const currentData = snapshot.val();
                    let needUpdate = false;

                    if (!currentData || Object.keys(currentData).length !== excelPrizes.length) {
                        needUpdate = true;
                    } else {
                        const currentPrizes = Object.values(currentData);
                        for (let i = 0; i < excelPrizes.length; i++) {
                            if (currentPrizes[i].name !== excelPrizes[i].name ||
                                currentPrizes[i].total !== excelPrizes[i].total) {
                                needUpdate = true;
                                break;
                            }
                        }
                    }

                    if (needUpdate) {
                        statusEl.textContent = 'ÂÅµÊ∏¨Âà∞ÁçéÂìÅËÆäÊõ¥ÔºåÊ≠£Âú®Ëá™ÂãïÊõ¥Êñ∞Ë≥áÊñôÂ∫´...';
                        // Ê∏ÖÁ©∫‰∏¶ÈáçÊñ∞ÂØ´ÂÖ•
                        const newPrizes = {};
                        excelPrizes.forEach(p => {
                            const key = prizesRef.push().key;
                            newPrizes[key] = {
                                name: p.name,
                                total: p.total,
                                remain: p.remain
                            };
                        });
                        prizesRef.set(newPrizes).then(() => {
                            statusEl.textContent = 'ÁçéÂìÅÂ∑≤Ëá™ÂãïËºâÂÖ•‰∏¶Êõ¥Êñ∞ÂÆåÊàêÔºÅ';
                        });
                    } else {
                        statusEl.textContent = 'ÁçéÂìÅË≥áÊñôÂ∑≤ËºâÂÖ•ÔºàÁÑ°ÈúÄÊõ¥Êñ∞Ôºâ';
                    }
                });
            })
            .catch(err => {
                statusEl.textContent = 'ÈåØË™§Ôºö' + err.message + 'ÔºàË´ãÁ¢∫Ë™ç public Ë≥áÊñôÂ§æÂÖßÊúâ gifts.xlsxÔºâ';
                console.error(err);
            });
    };

    // Áõ£ËÅΩË≥áÊñôÂ∫´Âç≥ÊôÇÊõ¥Êñ∞
    prizesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            prizes = Object.keys(data).map(key => ({
                id: key,
                name: data[key].name,
                total: data[key].total,
                remain: data[key].remain
            }));
        } else {
            prizes = [];
        }
        renderTable();
        updateDrawButton();
    });

    function renderTable() {
        const tbody = document.querySelector('#prizeTable tbody');
        tbody.innerHTML = '';
        if (prizes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#95a5a6;">Â∞öÊú™ËºâÂÖ•ÁçéÂìÅ</td></tr>';
            return;
        }
        prizes.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${p.name}</td>
                <td>${p.total}</td>
                <td>${p.remain} ${p.remain === 0 ? '<span style="color:#e74c3c;">(Â∑≤ÊäΩÂÆå)</span>' : ''}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateDrawButton() {
        const canDraw = prizes.some(p => p.remain > 0);
        document.getElementById('drawBtn').disabled = !canDraw;
        if (!canDraw && prizes.length > 0) {
            document.getElementById('result').textContent = 'ÁçéÂìÅÂ∑≤ÂÖ®ÈÉ®ÊäΩÂÆåÔºÅ';
        }
    }

    // ÊäΩÁçé
    function draw() {
        const available = prizes.filter(p => p.remain > 0);
        if (available.length === 0) return;

        const totalRemain = available.reduce((sum, p) => sum + p.remain, 0);
        let random = Math.random() * totalRemain;
        let selected;
        for (const item of available) {
            random -= item.remain;
            if (random <= 0) {
                selected = item;
                break;
            }
        }

        db.ref('prizes/' + selected.id + '/remain').set(selected.remain - 1);
        document.getElementById('result').textContent = `üéâ ÊÅ≠ÂñúÊäΩ‰∏≠Ôºö${selected.name} üéâ`;
    }
</script>
</body>
</html>