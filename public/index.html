<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å¥½ç¦®å³æ™‚æŠ½</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background: #f0f8ff;
        color: #333;
        text-align: center;
        position: relative;
    }
    h1 {
        color: #2c3e50;
        margin-bottom: 40px;
    }
    .section {
        background: white;
        padding: 40px 20px;
        border-radius: 15px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    #drawBtn {
        width: 100%;
        padding: 30px;
        font-size: 32px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        margin: 20px 0;
        transition: background 0.3s;
    }
    #drawBtn:hover:not(:disabled) {
        background: #c0392b;
    }
    #drawBtn:disabled {
        background: #95a5a6;
        cursor: not-allowed;
    }
    #result {
        font-size: 36px;
        min-height: 100px;
        font-weight: bold;
        color: #27ae60;
        margin: 40px 0;
    }
    /* æŠ½çå‹•ç•« */
    .spinner {
        display: inline-block;
        width: 60px;
        height: 60px;
        border: 8px solid #f3f3f3;
        border-top: 8px solid #e74c3c;
        border-radius: 50%;
        animation: spin 1.5s linear infinite;
        margin: 20px auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    #status {
        color: #7f8c8d;
        font-style: italic;
        margin-top: 20px;
    }

    /* å³ä¸Šè§’é‡ç½®æŒ‰éˆ• */
    #resetBtn {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        transition: all 0.3s;
    }
    #resetBtn:hover {
        background: #c0392b;
        transform: scale(1.1);
    }
</style>
</head>
<body>
    <h1>å¥½ç¦®å³æ™‚æŠ½ï¼</h1>
<!-- TODO: æ”¹renew button æ¨£å¼ -->
    <!-- å³ä¸Šè§’ç®¡ç†å“¡é‡ç½®æŒ‰éˆ• -->
    <button id="resetBtn" title="ç®¡ç†å“¡å°ˆç”¨ï¼šé‡ç½®çå“æ•¸é‡">ğŸ”„</button>

    <div class="section">
        <!-- ä¸»æŠ½çæŒ‰éˆ•ï¼ˆåˆå§‹é¡¯ç¤ºï¼ŒæŠ½ä¸­å¾Œéš±è—ï¼‰ -->
        <button id="drawBtn" onclick="startDraw()">é–‹å§‹æŠ½çï¼</button>

        <!-- æŠ½çéç¨‹èˆ‡çµæœé¡¯ç¤ºå€ -->
        <div id="animation"></div>
        <div id="result"></div>
        <div id="status">ç³»çµ±è¼‰å…¥ä¸­...</div>
    </div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<!-- SheetJS for Excel reading -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD7FUyMpktNug1cBDL7Ea_flnkx0MfB4zc",
        authDomain: "amc-lottery.firebaseapp.com",
        projectId: "amc-lottery",
        storageBucket: "amc-lottery.firebasestorage.app",
        messagingSenderId: "845041629032",
        appId: "1:845041629032:web:aa953f10727759475f48dd",
        measurementId: "G-X6L8K2X0KP"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const prizesRef = db.ref('prizes');

    let prizes = [];
    const statusEl = document.getElementById('status');
    const drawBtn = document.getElementById('drawBtn');
    const animationEl = document.getElementById('animation');
    const resultEl = document.getElementById('result');

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•è®€å– gifts.xlsx ä¸¦åˆå§‹åŒ–è³‡æ–™åº«
    window.onload = function() {
        loadAndInitPrizes();
    };

    // å…±ç”¨å‡½æ•¸ï¼šè®€å– gifts.xlsx ä¸¦æ ¹æ“šéœ€è¦åˆå§‹åŒ–/é‡ç½®è³‡æ–™åº«
    function loadAndInitPrizes(forceReset = false) {
        fetch('gifts.xlsx')
            .then(response => {
                if (!response.ok) throw new Error('æ‰¾ä¸åˆ° gifts.xlsx');
                return response.arrayBuffer();
            })
            .then(data => {
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                const excelPrizes = json.slice(1)
                    .filter(row => row[0] && row[1] > 0)
                    .map(row => ({
                        name: row[0].toString().trim(),
                        total: parseInt(row[1]) || 0,
                        remain: parseInt(row[1]) || 0
                    }));

                if (excelPrizes.length === 0) {
                    statusEl.textContent = 'éŒ¯èª¤ï¼šgifts.xlsx ä¸­æ²’æœ‰æœ‰æ•ˆçå“è³‡æ–™';
                    return;
                }

                if (forceReset) {
                    statusEl.textContent = 'æ­£åœ¨å¼·åˆ¶é‡ç½®çå“è³‡æ–™...';
                    writePrizesToDB(excelPrizes);
                } else {
                    prizesRef.once('value').then(snapshot => {
                        const currentData = snapshot.val();
                        let needUpdate = false;

                        if (!currentData || Object.keys(currentData).length !== excelPrizes.length) {
                            needUpdate = true;
                        } else {
                            const currentPrizes = Object.values(currentData);
                            for (let i = 0; i < excelPrizes.length; i++) {
                                if (currentPrizes[i].name !== excelPrizes[i].name ||
                                    currentPrizes[i].total !== excelPrizes[i].total) {
                                    needUpdate = true;
                                    break;
                                }
                            }
                        }

                        if (needUpdate) {
                            statusEl.textContent = 'æ­£åœ¨åˆå§‹åŒ–çå“è³‡æ–™...';
                            writePrizesToDB(excelPrizes);
                        } else {
                            statusEl.textContent = 'ç³»çµ±å·²å°±ç·’ï¼Œæ­¡è¿æŠ½çï¼';
                            resetToInitialState();
                        }
                    });
                }
            })
            .catch(err => {
                statusEl.textContent = 'éŒ¯èª¤ï¼š' + err.message;
                console.error(err);
            });
    }

    // å°‡çå“å¯«å…¥è³‡æ–™åº«
    function writePrizesToDB(excelPrizes) {
        const newPrizes = {};
        excelPrizes.forEach(p => {
            const key = prizesRef.push().key;
            newPrizes[key] = { name: p.name, total: p.total, remain: p.remain };
        });
        prizesRef.set(newPrizes).then(() => {
            statusEl.textContent = 'ç³»çµ±å·²å°±ç·’ï¼Œæ­¡è¿æŠ½çï¼';
            resetToInitialState();
        });
    }

    // å³æ™‚ç›£è½çå“å‰©é¤˜æ•¸é‡
    prizesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            prizes = Object.keys(data).map(key => ({
                id: key,
                name: data[key].name,
                total: data[key].total,
                remain: data[key].remain
            }));
        } else {
            prizes = [];
        }
        // åªåœ¨åˆå§‹ç‹€æ…‹æ™‚æ›´æ–°æŒ‰éˆ•ï¼ˆçµæœé é¢ä¸é¡¯ç¤ºä¸»æŒ‰éˆ•ï¼‰
        if (resultEl.innerHTML === '' && animationEl.innerHTML === '') {
            updateButtonState();
        }
    });

    // æ›´æ–°ä¸»æŠ½çæŒ‰éˆ•ç‹€æ…‹ï¼ˆåƒ…åœ¨åˆå§‹ç•«é¢æ™‚å‘¼å«ï¼‰
    function updateButtonState() {
        const canDraw = prizes.some(p => p.remain > 0);

        drawBtn.style.display = 'block'; // ç¢ºä¿é¡¯ç¤º

        if (canDraw) {
            drawBtn.textContent = 'é–‹å§‹æŠ½çï¼';
            drawBtn.disabled = false;
            drawBtn.onclick = startDraw;
        } else if (prizes.length > 0) {
            drawBtn.textContent = 'çå“å·²æŠ½å®Œ';
            drawBtn.disabled = true;
            drawBtn.onclick = null;
        }
    }

    // å›åˆ°åˆå§‹æŠ½çç•«é¢
    function resetToInitialState() {
        resultEl.innerHTML = '';
        animationEl.innerHTML = '';
        updateButtonState(); // é‡æ–°é¡¯ç¤ºä¸¦æ›´æ–°ä¸»æŒ‰éˆ•
    }

    // é–‹å§‹æŠ½ç
    function startDraw() {
        if (prizes.filter(p => p.remain > 0).length === 0) return;

        drawBtn.style.display = 'none'; // éš±è—ä¸»æŒ‰éˆ•
        drawBtn.textContent = 'æŠ½çä¸­â€¦';
        resultEl.textContent = '';
        animationEl.innerHTML = '<div class="spinner"></div>';

        setTimeout(() => {
            performDraw();
        }, 2000);
    }

    // åŸ·è¡ŒæŠ½çä¸¦é¡¯ç¤ºçµæœï¼ˆæ­¤æ™‚ä¸»æŒ‰éˆ•å·²éš±è—ï¼‰
    function performDraw() {
        const available = prizes.filter(p => p.remain > 0);
        const totalRemain = available.reduce((sum, p) => sum + p.remain, 0);
        let random = Math.random() * totalRemain;
        let selected;

        for (const item of available) {
            random -= item.remain;
            if (random <= 0) {
                selected = item;
                break;
            }
        }

        db.ref('prizes/' + selected.id + '/remain').set(selected.remain - 1);

        animationEl.innerHTML = '';
        resultEl.innerHTML = `
            <div>ğŸ‰ æ­å–œæŠ½ä¸­ï¼š<br><strong style="font-size:42px;">${selected.name}</strong> ğŸ‰</div>
            <button onclick="resetToInitialState()" style="margin-top:30px; padding:15px 30px; font-size:24px; background:#27ae60; color:white; border:none; border-radius:10px; cursor:pointer;">
                å›åˆ°æŠ½çç•«é¢
            </button>
        `;
    }

    // å³ä¸Šè§’é‡ç½®æŒ‰éˆ•åŠŸèƒ½
    document.getElementById('resetBtn').addEventListener('click', () => {
        if (confirm('âš ï¸ ç®¡ç†å“¡æ“ä½œ âš ï¸\n\nç¢ºå®šè¦å¼·åˆ¶é‡ç½®æ‰€æœ‰çå“æ•¸é‡ç‚ºåˆå§‹å€¼å—ï¼Ÿ\næ­¤æ“ä½œæœƒæ¸…é™¤ç›®å‰æ‰€æœ‰æŠ½çé€²åº¦ã€‚')) {
            statusEl.textContent = 'æ­£åœ¨å¼·åˆ¶é‡ç½®çå“è³‡æ–™...';
            loadAndInitPrizes(true);
            alert('çå“å·²æˆåŠŸé‡ç½®ï¼é‡æ–°æ•´ç†é é¢å¾Œå³ç”Ÿæ•ˆã€‚');
        }
    });
</script>
</body>
</html>