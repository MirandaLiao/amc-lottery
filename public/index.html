<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å¥½ç¦®å³æ™‚æŠ½</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background: #f0f8ff;
        color: #333;
        text-align: center;
        position: relative;
    }
    h1 {
        color: #2c3e50;
        margin-bottom: 40px;
    }
    .section {
        background: white;
        padding: 40px 20px;
        border-radius: 15px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    #drawBtn {
        width: 100%;
        padding: 30px;
        font-size: 32px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        margin: 20px 0;
        transition: background 0.3s;
    }
    #drawBtn:hover:not(:disabled) {
        background: #c0392b;
    }
    #drawBtn:disabled {
        background: #95a5a6;
        cursor: not-allowed;
    }
    #result {
        font-size: 36px;
        min-height: 100px;
        font-weight: bold;
        color: #27ae60;
        margin: 40px 0;
    }
    .spinner {
        display: inline-block;
        width: 60px;
        height: 60px;
        border: 8px solid #f3f3f3;
        border-top: 8px solid #e74c3c;
        border-radius: 50%;
        animation: spin 1.5s linear infinite;
        margin: 20px auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    #status {
        color: #7f8c8d;
        font-style: italic;
        margin-top: 20px;
    }

    /* å³ä¸Šè§’é‡ç½®æŒ‰éˆ• */
    #resetBtn {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        color: black;
        background: rgba(255,255,255,0.8);
        border: none;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        transition: all 0.3s;
    }
    #resetBtn:hover {
        transform: scale(1.1);
        background: white;
    }

    /* è‡ªè¨‚å¯†ç¢¼è¼¸å…¥è¦–çª— */
    #passwordModal {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .modal-content h3 {
        margin: 0 0 20px 0;
        color: #2c3e50;
    }
    #passwordInput {
        width: 100%;
        padding: 12px;
        font-size: 18px;
        border: 2px solid #ddd;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
    }
    .modal-buttons button {
        padding: 10px 20px;
        margin: 0 10px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }
    #confirmPwdBtn {
        background: #27ae60;
        color: white;
    }
    #cancelPwdBtn {
        background: #95a5a6;
        color: white;
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <h1>å¥½ç¦®å³æ™‚æŠ½ï¼</h1>

    <!-- å³ä¸Šè§’ç®¡ç†å“¡é‡ç½®æŒ‰éˆ• -->
    <button id="resetBtn" title="ç®¡ç†å“¡å°ˆç”¨ï¼šé‡ç½®çå“æ•¸é‡">
        <i class="fas fa-sync-alt"></i>
    </button>

    <div class="section">
        <button id="drawBtn" onclick="startDraw()">é–‹å§‹æŠ½çï¼</button>
        <div id="animation"></div>
        <div id="result"></div>
        <div id="status">ç³»çµ±è¼‰å…¥ä¸­...</div>
    </div>

    <!-- è‡ªè¨‚å¯†ç¢¼è¼¸å…¥è¦–çª— -->
    <div id="passwordModal">
        <div class="modal-content">
            <h3>è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼</h3>
            <input type="password" id="passwordInput" placeholder="è¼¸å…¥å¯†ç¢¼" />
            <div class="modal-buttons">
                <button id="confirmPwdBtn">ç¢ºèª</button>
                <button id="cancelPwdBtn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD7FUyMpktNug1cBDL7Ea_flnkx0MfB4zc",
        authDomain: "amc-lottery.firebaseapp.com",
        projectId: "amc-lottery",
        storageBucket: "amc-lottery.firebasestorage.app",
        messagingSenderId: "845041629032",
        appId: "1:845041629032:web:aa953f10727759475f48dd",
        measurementId: "G-X6L8K2X0KP"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const prizesRef = db.ref('prizes');

    let prizes = [];
    const statusEl = document.getElementById('status');
    const drawBtn = document.getElementById('drawBtn');
    const animationEl = document.getElementById('animation');
    const resultEl = document.getElementById('result');

    // === ç®¡ç†å“¡å¯†ç¢¼ ===
    const ADMIN_PASSWORD = "1234";

    // è‡ªå‹•é¸æ“‡ Excel æª”æ¡ˆ
    function getExcelFilename() {
        const today = new Date();
        const startDate = new Date('2026-01-09'); // æ´»å‹•"ç¬¬ä¸€å¤©" æ—¥æœŸ

        const diffDays = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));

        if (diffDays < 0) {
            return 'gifts_test.xlsx';        // æ´»å‹•å‰æ¸¬è©¦ç”¨
        } else if (diffDays === 0) {
            return 'gifts_first.xlsx';       // ç¬¬ä¸€å¤©
        } else if (diffDays === 1) {
            return 'gifts_second.xlsx';      // ç¬¬äºŒå¤©
        } else {
            return 'gifts_test.xlsx';
        }
    }

    function loadAndInitPrizes(forceReset = false) {
        const filename = getExcelFilename();
        statusEl.textContent = `æ­£åœ¨è¼‰å…¥ ${filename} ...`;

        fetch(filename)
            .then(response => {
                if (!response.ok) throw new Error(`æ‰¾ä¸åˆ° ${filename}`);
                return response.arrayBuffer();
            })
            .then(data => {
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                const excelPrizes = json.slice(1)
                    .filter(row => row[0] && row[1] > 0)
                    .map(row => ({
                        name: row[0].toString().trim(),
                        total: parseInt(row[1]) || 0,
                        remain: parseInt(row[1]) || 0
                    }));

                if (excelPrizes.length === 0) {
                    statusEl.textContent = 'éŒ¯èª¤ï¼šExcel ä¸­æ²’æœ‰æœ‰æ•ˆçå“è³‡æ–™';
                    return;
                }

                if (forceReset) {
                    statusEl.textContent = 'æ­£åœ¨å¼·åˆ¶é‡ç½®çå“è³‡æ–™...';
                    writePrizesToDB(excelPrizes);
                } else {
                    prizesRef.once('value').then(snapshot => {
                        const currentData = snapshot.val();
                        let needUpdate = false;

                        if (!currentData || Object.keys(currentData).length !== excelPrizes.length) {
                            needUpdate = true;
                        } else {
                            const currentPrizes = Object.values(currentData);
                            for (let i = 0; i < excelPrizes.length; i++) {
                                if (currentPrizes[i].name !== excelPrizes[i].name ||
                                    currentPrizes[i].total !== excelPrizes[i].total) {
                                    needUpdate = true;
                                    break;
                                }
                            }
                        }

                        if (needUpdate) {
                            statusEl.textContent = 'æ­£åœ¨åˆå§‹åŒ–çå“è³‡æ–™...';
                            writePrizesToDB(excelPrizes);
                        } else {
                            statusEl.textContent = 'ç³»çµ±å·²å°±ç·’ï¼Œæ­¡è¿æŠ½çï¼';
                            resetToInitialState();
                        }
                    });
                }
            })
            .catch(err => {
                statusEl.textContent = 'éŒ¯èª¤ï¼š' + err.message;
                console.error(err);
            });
    }

    function writePrizesToDB(excelPrizes) {
        const newPrizes = {};
        excelPrizes.forEach(p => {
            const key = prizesRef.push().key;
            newPrizes[key] = { name: p.name, total: p.total, remain: p.remain };
        });
        prizesRef.set(newPrizes).then(() => {
            statusEl.textContent = 'ç³»çµ±å·²å°±ç·’ï¼Œæ­¡è¿æŠ½çï¼';
            resetToInitialState();
        });
    }

    prizesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            prizes = Object.keys(data).map(key => ({
                id: key,
                name: data[key].name,
                total: data[key].total,
                remain: data[key].remain
            }));
        } else {
            prizes = [];
        }
        if (resultEl.innerHTML === '' && animationEl.innerHTML === '') {
            updateButtonState();
        }
    });

    function updateButtonState() {
        const canDraw = prizes.some(p => p.remain > 0);
        drawBtn.style.display = 'block';

        if (canDraw) {
            drawBtn.textContent = 'é–‹å§‹æŠ½çï¼';
            drawBtn.disabled = false;
            drawBtn.onclick = startDraw;
        } else if (prizes.length > 0) {
            drawBtn.textContent = 'çå“å·²æŠ½å®Œ';
            drawBtn.disabled = true;
            drawBtn.onclick = null;
        }
    }

    function resetToInitialState() {
        resultEl.innerHTML = '';
        animationEl.innerHTML = '';
        updateButtonState();
    }

    function startDraw() {
        if (prizes.filter(p => p.remain > 0).length === 0) return;

        drawBtn.style.display = 'none';
        resultEl.textContent = '';
        animationEl.innerHTML = '<div class="spinner"></div>';

        setTimeout(() => {
            performDraw();
        }, 2000);
    }

    function performDraw() {
        const available = prizes.filter(p => p.remain > 0);
        const totalRemain = available.reduce((sum, p) => sum + p.remain, 0);
        let random = Math.random() * totalRemain;
        let selected;

        for (const item of available) {
            random -= item.remain;
            if (random <= 0) {
                selected = item;
                break;
            }
        }

        db.ref('prizes/' + selected.id + '/remain').set(selected.remain - 1);

        animationEl.innerHTML = '';
        resultEl.innerHTML = `
            <div>ğŸ‰ æ­å–œæŠ½ä¸­ï¼š<br><strong style="font-size:42px;">${selected.name}</strong> ğŸ‰</div>
            <button onclick="resetToInitialState()" style="margin-top:30px; padding:15px 30px; font-size:24px; background:#27ae60; color:white; border:none; border-radius:10px; cursor:pointer;">
                å›åˆ°æŠ½çç•«é¢
            </button>
        `;
    }

    // === é‡ç½®æŒ‰éˆ• + å¯†ç¢¼é©—è­‰ ===
    const modal = document.getElementById('passwordModal');
    const pwdInput = document.getElementById('passwordInput');

    document.getElementById('resetBtn').addEventListener('click', () => {
        modal.style.display = 'flex';
        pwdInput.value = '';
        pwdInput.focus();
    });

    document.getElementById('cancelPwdBtn').addEventListener('click', () => {
        modal.style.display = 'none';
    });

    document.getElementById('confirmPwdBtn').addEventListener('click', () => {
        if (pwdInput.value === ADMIN_PASSWORD) {
            modal.style.display = 'none';
            if (confirm('âš ï¸ ç®¡ç†å“¡æ“ä½œ âš ï¸\n\nç¢ºå®šè¦å¼·åˆ¶é‡ç½®æ‰€æœ‰çå“æ•¸é‡ç‚ºåˆå§‹å€¼å—ï¼Ÿ\næ­¤æ“ä½œæœƒæ¸…é™¤ç›®å‰æ‰€æœ‰æŠ½çé€²åº¦ï¼')) {
                statusEl.textContent = 'æ­£åœ¨å¼·åˆ¶é‡ç½®çå“è³‡æ–™...';
                loadAndInitPrizes(true);
                alert('çå“å·²æˆåŠŸé‡ç½®ï¼æ‰€æœ‰åƒèˆ‡è€…é‡æ–°æ•´ç†é é¢å¾Œå³ç”Ÿæ•ˆã€‚');
            }
        } else {
            alert('å¯†ç¢¼éŒ¯èª¤ï¼');
            pwdInput.value = '';
            pwdInput.focus();
        }
    });

    // æ”¯æ´ Enter éµç¢ºèª
    pwdInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('confirmPwdBtn').click();
        }
    });

    window.onload = function() {
        loadAndInitPrizes();
    };
</script>
</body>
</html>